!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?e(exports):"function"==typeof define&&define.amd?define(["exports"],e):e((t="undefined"!=typeof globalThis?globalThis:t||self).Galaxy={})}(this,(function(t){"use strict";var e=function(t,n){return e=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var n in e)e.hasOwnProperty(n)&&(t[n]=e[n])},e(t,n)};function n(t,n){function o(){this.constructor=t}e(t,n),t.prototype=null===n?Object.create(n):(o.prototype=n.prototype,new o)}var o,i,a=function(){return a=Object.assign||function(t){for(var e,n=1,o=arguments.length;n<o;n++)for(var i in e=arguments[n])Object.prototype.hasOwnProperty.call(e,i)&&(t[i]=e[i]);return t},a.apply(this,arguments)},r="searchkings_galaxy_clickId",s="searchkings_galaxy_form_data";!function(t){t.INJECT="inject",t.CAPTURE="capture",t.TRACKING="tracking"}(o||(o={})),function(t){t.GOOGLE="google",t.MICROSOFT="microsoft"}(i||(i={}));var l,u=function(){function t(){}return t.getClickId=function(t,e){var n=JSON.parse(localStorage.getItem(t));return n&&e===(null==n?void 0:n.platform)&&(new Date).getTime()<(null==n?void 0:n.expiryTimestamp)?null==n?void 0:n.clickId:null},t.getExpiryRecord=function(t,e){return{clickId:t,platform:e,expiryTimestamp:(new Date).getTime()+7776e6}},t.getParam=function(t){var e=RegExp("[?&]"+t+"=([^&]*)").exec(window.location.search);return e&&decodeURIComponent(e[1].replace(/\+/g," "))},t}();!function(t){t.GCLID="gclid",t.MSCLKID="msclkid"}(l||(l={}));var c=function(t){function e(){return null!==t&&t.apply(this,arguments)||this}return n(e,t),e.setValue=function(){var t=this.getParam(e.field),n=this.getParam("gclsrc"),o=!n||-1!==n.indexOf("aw");if(t&&o){var a=this.getExpiryRecord(t,i.GOOGLE);localStorage.setItem(r,JSON.stringify(a))}},e.getValue=function(){return e.setValue(),t.getClickId.call(this,r,i.GOOGLE)},e.field=l.GCLID,e}(u),d=function(t){function e(){return null!==t&&t.apply(this,arguments)||this}return n(e,t),e.setValue=function(){var t=this.getParam(e.field);if(t){var n=this.getExpiryRecord(t,i.MICROSOFT);localStorage.setItem(r,JSON.stringify(n))}},e.getValue=function(){return e.setValue(),t.getClickId.call(this,r,i.MICROSOFT)},e.field=l.MSCLKID,e}(u),f=function(t){var e=function(t){for(var e=[],n=new RegExp(/([a-zA-Z0-9._-]+@[a-zA-Z0-9._-]+\.[a-zA-Z0-9_-]+)/gi),o=I(t),i=0,a=Object.entries(o);i<a.length;i++){var r=a[i];r[0];var s=r[1];"string"==typeof s&&n.test(s)&&e.push(s)}return e[0]}(t);e&&sessionStorage.setItem("searchkings_galaxy_tracking_event_data",JSON.stringify({email:e}))},p=function(){function t(t){this.options=t,this.fieldsToInject=[{name:c.field,value:c.getValue()},{name:d.field,value:d.getValue()}]}return t.prototype.injectAll=function(){var t=m(this.options);this.formsInjector(t)},t.prototype.inject=function(t){this.formsInjector(t)},t.prototype.formsInjector=function(t){for(var e=this,n=function(t){for(var n=0,i=o.fieldsToInject;n<i.length;n++){var a=i[n],r=a.name,s=a.value;if(s){var l=document.createElement("input");l.setAttribute("type","hidden"),l.setAttribute("id",r),l.setAttribute("name",r),l.setAttribute("value",s),t.appendChild(l)}}t.addEventListener("submit",(function(){var n;(null===(n=e.options)||void 0===n?void 0:n.debug)&&console.log("[Galaxy Debug]: ".concat(e.options.mode," form submission listener triggered: submit")),f(t),x(t)}))},o=this,i=0,a=t;i<a.length;i++){n(a[i])}},t}(),g=function(){function t(t){this.options=t}return t.prototype.trackAll=function(){var t=m(this.options);this.userDataTracker(t)},t.prototype.track=function(t){this.userDataTracker(t)},t.prototype.userDataTracker=function(t){for(var e=this,n=function(t){t.addEventListener("submit",(function(){var n;(null===(n=e.options)||void 0===n?void 0:n.debug)&&console.log("[Galaxy Debug]: ".concat(e.options.mode," form submission listener triggered: submit")),f(t);var o=null==t?void 0:t.action;"string"==typeof o&&((null==o?void 0:o.includes("galaxy.searchkings.ca/"))||(null==o?void 0:o.includes("galaxy-dev.searchkings.ca/")))&&x(t)}))},o=0,i=t;o<i.length;o++){n(i[o])}},t}(),v=function(t){for(var e=[],n=0,o=t;n<o.length;n++){var i=o[n];document.querySelectorAll(i).forEach((function(t){t&&t instanceof HTMLFormElement&&e.push(t)}))}return e},h=function(t){void 0===t&&(t=document);var e=t.getElementsByTagName("form");return Array.from(e)},m=function(t){var e=t.mode,n=t.debug,o=t.includedSelectors,i=t.excludedSelectors,a=[];if((null==o?void 0:o.length)&&(null==i?void 0:i.length))throw new Error("You cannot specify includedSelectors and excludedSelectors at the same time.");if(null==o?void 0:o.length)a=v(o);else if(null==i?void 0:i.length){var r=h(),s=v(i);a=r.filter((function(t){return!s.includes(t)}))}else a=h();return n&&console.log("[Galaxy Debug]: All trackable ".concat(e," forms"),a),a},y=function(t){var e=sessionStorage.getItem(t),n=JSON.parse(e||"{}");return Object.keys(n).length?n:null},b=function(t,e){var n=document.body,i=window.MutationObserver;if(i){var a=new i((function(n){!function(t,e,n){for(var i=[],a=0,r=e;a<r.length;a++){var s=r[a].addedNodes;Array.from(s).forEach((function(t){t instanceof HTMLFormElement?i.push(t):t instanceof HTMLElement&&h(t).forEach((function(t){i.push(t)}))}))}if(null==i?void 0:i.length){var l=m(n).filter((function(t){return i.includes(t)}));switch((null==n?void 0:n.debug)&&console.log("[Galaxy Debug]: new ".concat(n.mode," forms detected"),i),n.mode){case o.INJECT:new p(n).inject(l);break;case o.CAPTURE:new E(t,n).capture(l);break;case o.TRACKING:new g(n).track(l)}}}(t,n,e)}));return a.observe(n,{childList:!0,subtree:!0})}},x=function(t){var e=t.querySelector('button[type="submit"]');e&&(e.setAttribute("disabled","true"),e.style.setProperty("opacity","0.5","important"),setTimeout((function(){e.removeAttribute("disabled"),e.style.removeProperty("opacity")}),3e3))},I=function(t){var e=new FormData(t);return Object.fromEntries(e)},w=function(){function t(t,e,n){this.galaxyId=t,this.data=e,this.options=n,this.galaxyFormURI="".concat("https://galaxy.searchkings.ca","/").concat(t),this.request(e)}return t.prototype.request=function(t){var e,n,o;t.galaxy_capture_request=!0;var i="navigator"in window&&"sendBeacon"in window.navigator;if((null===(e=this.options)||void 0===e?void 0:e.debug)&&console.log("[Galaxy Debug]: Beacon API supported: ".concat(i)),i){var a=window.navigator.sendBeacon.bind(window.navigator)(this.galaxyFormURI,new Blob([JSON.stringify(t)],{type:"application/json"}));(null===(n=this.options)||void 0===n?void 0:n.debug)&&console.log("[Galaxy Debug]: sendBeacon queued: ".concat(a)),a||this.xmlHttpRequest(t)}else this.xmlHttpRequest(t);(null===(o=this.options)||void 0===o?void 0:o.debug)&&console.log("[Galaxy Debug]: form submission dispatched, form ID ".concat(this.galaxyId))},t.prototype.xmlHttpRequest=function(t){t.xhr=!0;var e=new XMLHttpRequest;e.open("POST",this.galaxyFormURI,!0),e.setRequestHeader("Content-type","application/json"),e.setRequestHeader("X-Requested-With","XMLHttpRequest"),e.send(JSON.stringify(t))},t}(),E=function(){function t(t,e){var n=this;this.galaxyId=t,this.options=e,this.addEventToElements=function(t){var e=t.form,o=t.eventType,i=t.isClickEvent;(t.submitButton||e).addEventListener(o,(function(t){var r,l,u;(null===(r=n.options)||void 0===r?void 0:r.debug)&&console.log("[Galaxy Debug]: ".concat(n.options.mode," form submission listener triggered: ").concat(o)),f(e);var c=n.getFormData(e);if(c)if(i){var d="".concat(s,"_").concat(n.galaxyId),p=y(d),g=a(a({},p||{}),c);sessionStorage.setItem(d,JSON.stringify(g))}else new w(n.galaxyId,c,{debug:null===(l=n.options)||void 0===l?void 0:l.debug});(null===(u=n.options)||void 0===u?void 0:u.preventDefault)&&(t.preventDefault(),console.log("[Galaxy Debug]: the preventDefault() method is turned on"))}))}}return t.prototype.captureAll=function(){var t=m(this.options);this.formListener(this.galaxyId,t)},t.prototype.capture=function(t){this.formListener(this.galaxyId,t)},t.prototype.formListener=function(t,e){for(var n,o,i,a=this,r=function(t){var e=void 0,r=null===(o=null===(n=s.options)||void 0===n?void 0:n.formEventListeners)||void 0===o?void 0:o.find((function(e){return t.matches(e.selectors)})),l=(null==r?void 0:r.eventType)||"submit",u="click"===l;u&&(e=t.querySelectorAll('button[type="submit"]')||t.querySelectorAll('input[type="submit"]'),(null===(i=s.options)||void 0===i?void 0:i.debug)&&console.log("[Galaxy Debug]: total ".concat(null==e?void 0:e.length," form submission submitButtons: ").concat(e))),e&&e.length?e.forEach((function(e){return a.addEventToElements({form:t,eventType:l,isClickEvent:u,submitButton:e})})):s.addEventToElements({form:t,eventType:l,isClickEvent:u})},s=this,l=0,u=e;l<u.length;l++){r(u[l])}},t.prototype.getFormData=function(t){var e,n,o,i,a,r,s,l=I(t),u={},f=["g-recaptcha-response"],p=!!Object.keys((null===(e=this.options)||void 0===e?void 0:e.fieldNameMapping)||{}).length;(null===(n=this.options)||void 0===n?void 0:n.debug)&&console.log("[Galaxy Debug]: ".concat(this.options.mode," form submission raw data: ").concat(JSON.stringify(l)));for(var g=0,v=Object.entries(l);g<v.length;g++){var h=v[g],m=h[0],y=h[1];(null===(o=this.options)||void 0===o?void 0:o.fieldNameMapping)&&(null===(i=this.options)||void 0===i?void 0:i.fieldNameMapping[m])&&""!==(null===(a=this.options)||void 0===a?void 0:a.fieldNameMapping[m])?u[this.options.fieldNameMapping[m]]=y:p||y instanceof File||f.includes(m)||(u[m]=y)}(null===(r=this.options)||void 0===r?void 0:r.debug)&&console.log("[Galaxy Debug]: ".concat(this.options.mode," form submission dispatch data: ").concat(JSON.stringify(u)));var b=Object.values(u).every((function(t){return null===t||""===t||0===(null==t?void 0:t.size)})),x=c.getValue(),w=d.getValue(),E=!(null===(s=this.options)||void 0===s?void 0:s.adTrafficOnly)||!!x||!!w;return!b&&E?(x&&(u[c.field]=x),w&&(u[d.field]=w),u):null},t}(),O=function(){function t(t){this.galaxyId=t}return t.prototype.init=function(t){var e={adTrafficOnly:!0,mode:o.TRACKING};if(t=a(a({},e),t),!this.galaxyId&&t.mode!==o.TRACKING)throw new Error("You must specify a Galaxy ID for the instance");switch(b(this.galaxyId,t),c.setValue(),d.setValue(),t.mode){case o.INJECT:new p(t).injectAll();break;case o.CAPTURE:new E(this.galaxyId,t).captureAll();break;case o.TRACKING:new g(t).trackAll();break;default:throw new Error("Invalid Galaxy mode specified, must be one of 'inject', 'capture' or 'tracking(default)'")}},t.prototype.dispatch=function(t){if(!this.galaxyId)throw new Error("You must specify a Galaxy ID for the instance");var e="".concat(s,"_").concat(this.galaxyId),n=y(e);sessionStorage.removeItem(e),n&&new w(this.galaxyId,n,t)},t}();window.Galaxy=O,t.Galaxy=O,Object.defineProperty(t,"__esModule",{value:!0})}));
